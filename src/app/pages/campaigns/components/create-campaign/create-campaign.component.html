<div class="create-campaign-container">
  <!-- Header with actions -->
  <div class="campaign-header">
    <div class="flex align-items-center gap-3">
      <p-button
        icon="pi pi-arrow-left"
        [text]="true"
        [rounded]="true"
        (onClick)="goBack()"
        ariaLabel="Volver al listado"
      ></p-button>
      <h1 class="text-3xl font-bold m-0">
        <ng-container *ngIf="isEditMode(); else createMode">
          Editar Campaña: {{ campaignToEdit()?.title || 'Sin título' }}
        </ng-container>
        <ng-template #createMode>
          {{ template()?.name ? 'Crear Campaña desde ' + template()?.name : 'Crear Nueva Campaña' }}
        </ng-template>
      </h1>
    </div>

    <div class="flex gap-2">
      <p-button
        label="Vista Previa"
        icon="pi pi-eye"
        [outlined]="true"
        (onClick)="openPreview()"
        ariaLabel="Vista previa ampliada"
      ></p-button>
      <p-button
        [label]="getActionButtonLabel()"
        [icon]="getActionButtonIcon()"
        [loading]="saving()"
        (onClick)="saveOrUpdate()"
        [ariaLabel]="getActionButtonLabel()"
      ></p-button>
    </div>
  </div>

  <!-- Main content: Two columns -->
  <div class="campaign-content">
    <div class="grid">
      <!-- Left column: Form (60%) -->
      <div class="col-12 lg:col-7 form-column">
        <p-card>
          <form [formGroup]="campaignForm" class="campaign-form">
            <!-- Información Básica -->
            <div class="form-section">
              <h3 class="section-title">Información Básica</h3>

              <div class="field">
                <label for="title" class="font-semibold">
                  Título de la Campaña *
                  <i class="pi pi-info-circle ml-2 text-500"
                     pTooltip="Este es el título principal que verán tus clientes. Debe ser llamativo y claro."
                     tooltipPosition="right"></i>
                </label>
                <input
                  pInputText
                  id="title"
                  formControlName="title"
                  placeholder="Ej: Super Descuento de Verano"
                  class="w-full"
                />
                <small class="p-error" *ngIf="campaignForm.get('title')?.touched && campaignForm.get('title')?.hasError('required')">
                  El título es requerido
                </small>
                <small class="text-500" *ngIf="!campaignForm.get('title')?.hasError('required')">
                  Usa un título corto y atractivo (máximo 60 caracteres recomendado)
                </small>
              </div>

              <div class="field">
                <label for="subtitle" class="font-semibold">
                  Subtítulo
                  <i class="pi pi-info-circle ml-2 text-500"
                     pTooltip="Complementa el título con información adicional. Es opcional pero recomendado."
                     tooltipPosition="right"></i>
                </label>
                <input
                  pInputText
                  id="subtitle"
                  formControlName="subtitle"
                  placeholder="Ej: Aprovecha las mejores ofertas"
                  class="w-full"
                />
                <small class="text-500">Agrega contexto o urgencia a tu campaña (opcional)</small>
              </div>

              <!-- Campo 'Descripción' movido: la descripción principal se manejará desde Configuración del Beneficio para evitar confusiones -->
            </div>

            <p-divider></p-divider>

            <!-- Imagen -->
            <div class="form-section">
              <h3 class="section-title">
                Imagen de la Campaña
                <i class="pi pi-info-circle ml-2 text-500"
                   pTooltip="Una imagen atractiva aumenta la efectividad de tu campaña hasta un 80%"
                   tooltipPosition="right"></i>
              </h3>

              <div class="field">
                <p-fileUpload
                  mode="basic"
                  chooseLabel="Seleccionar imagen"
                  chooseIcon="pi pi-upload"
                  accept="image/*"
                  [maxFileSize]="5000000"
                  (onSelect)="onImageUpload($event)"
                  [auto]="true"
                  class="w-full"
                ></p-fileUpload>
                <small class="text-500">
                  <strong>Recomendación:</strong> Usa imágenes de alta calidad en formato JPG o PNG.
                  Tamaño ideal: 1200x630 píxeles. Máximo: 5MB
                </small>

                <div class="mt-3" *ngIf="uploadedImageUrl() || campaignForm.get('imageUrl')?.value">
                  <img
                    [src]="uploadedImageUrl() || campaignForm.get('imageUrl')?.value"
                    alt="Vista previa"
                    class="preview-image"
                  />
                </div>
              </div>

              <!--
              <div class="field">
                <label for="imageUrl" class="font-semibold">
                  O ingresa una URL de imagen
                  <i class="pi pi-info-circle ml-2 text-500"
                     pTooltip="Si tu imagen ya está en línea, pega aquí la URL directa"
                     tooltipPosition="right"></i>
                </label>
                <input
                  pInputText
                  id="imageUrl"
                  formControlName="imageUrl"
                  placeholder="https://ejemplo.com/imagen.jpg"
                  class="w-full"
                />
                <small class="text-500">Alternativamente, pega la URL directa de tu imagen</small>
              </div>
              -->
            </div>

            <p-divider></p-divider>

            <!-- Configuración del Beneficio (Reward) -->
            <div class="form-section">
              <h3 class="section-title">
                Configuración del Beneficio
                <i class="pi pi-info-circle ml-2 text-500"
                   pTooltip="Define el tipo y valor exacto del beneficio que recibirán tus clientes"
                   tooltipPosition="right"></i>
              </h3>

              <!-- Resumen del beneficio actual -->
              <div class="field mb-4" *ngIf="isEditMode()">
                <div class="flex align-items-center justify-content-between p-3 border-round surface-border benefit-highlight" style="border: 1px solid var(--surface-border)">
                  <div class="flex align-items-center gap-3">
                    <i class="pi pi-gift text-3xl text-primary"></i>
                    <div>
                      <p class="font-semibold m-0 mb-1">Beneficio Actual</p>
                      <p class="text-500 m-0" *ngIf="!loadingReward()">{{ getRewardSummary() }}</p>
                      <p class="text-500 m-0" *ngIf="loadingReward()">
                        <i class="pi pi-spin pi-spinner"></i> Cargando...
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Componente de formulario de reward -->
              <app-reward-form #rewardFormComp
                [campaignId]="campaignId() ?? undefined"
                [existingReward]="currentReward() ?? undefined"
                [tenantId]="tenantId ?? undefined"
                (saved)="onRewardSaved($event)"
                (pending)="onPendingReward($event)"
              ></app-reward-form>
            </div>

            <p-divider></p-divider>

            <!-- Fechas -->
            <div class="form-section">
              <h3 class="section-title">
                Período de Vigencia
                <i class="pi pi-info-circle ml-2 text-500"
                   pTooltip="Define cuándo estará activa tu campaña. Puedes programarla con anticipación"
                   tooltipPosition="right"></i>
              </h3>

              <div class="grid">
                <div class="col-12 md:col-6">
                  <div class="field">
                    <label for="startDate" class="font-semibold">Fecha de Inicio *</label>
                    <p-datepicker
                      id="startDate"
                      formControlName="startDate"
                      placeholder="Selecciona fecha"
                      [showIcon]="true"
                      dateFormat="dd/mm/yy"
                      class="w-full"
                    ></p-datepicker>
                    <small class="p-error" *ngIf="campaignForm.get('startDate')?.touched && campaignForm.get('startDate')?.hasError('required')">
                      La fecha de inicio es requerida
                    </small>
                    <small class="text-500" *ngIf="!campaignForm.get('startDate')?.hasError('required')">
                      Día en que la campaña se activará
                    </small>
                  </div>
                </div>

                <div class="col-12 md:col-6">
                  <div class="field">
                    <label for="endDate" class="font-semibold">Fecha de Fin *</label>
                    <p-datepicker
                      id="endDate"
                      formControlName="endDate"
                      placeholder="Selecciona fecha"
                      [showIcon]="true"
                      dateFormat="dd/mm/yy"
                      class="w-full"
                    ></p-datepicker>
                    <small class="p-error" *ngIf="campaignForm.get('endDate')?.touched && campaignForm.get('endDate')?.hasError('required')">
                      La fecha de fin es requerida
                    </small>
                    <small class="text-500" *ngIf="!campaignForm.get('endDate')?.hasError('required')">
                      Último día de vigencia de la campaña
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <p-divider></p-divider>

            <!-- Configuración Adicional -->
            <div class="form-section">
              <h3 class="section-title">
                Configuración Adicional
                <i class="pi pi-info-circle ml-2 text-500"
                   pTooltip="Define cómo y a quién llegará tu campaña"
                   tooltipPosition="right"></i>
              </h3>

              <!-- Status field - only visible in edit mode -->
              <div class="field" #statusSelect *ngIf="isEditMode()">
                <label for="status" class="font-semibold">
                  Estado de la Campaña
                  <i class="pi pi-info-circle ml-2 text-500"
                     pTooltip="Cambia el estado de tu campaña: Borrador (en edición), Activa (visible para clientes)"
                     tooltipPosition="right"></i>
                </label>
                <p-select
                  id="status"
                  formControlName="status"
                  [options]="statusOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Selecciona el estado"
                  class="w-full"
                ></p-select>
                <small class="text-500">
                  <span class="font-medium text-orange-600">Borrador:</span> En edición |
                  <span class="font-medium text-green-600">Activa:</span> Visible para clientes
                </small>
              </div>

              <!-- Informative message for new campaigns -->
              <div class="field" *ngIf="!isEditMode()">
                <div class="p-3 border-round bg-orange-50 border-1 border-orange-200">
                  <div class="flex align-items-start gap-2">
                    <i class="pi pi-info-circle text-orange-600 mt-1"></i>
                    <div>
                      <p class="m-0 font-semibold text-orange-900">Campaña se guardará como Borrador</p>
                      <p class="m-0 mt-1 text-sm text-orange-800">
                        La campaña se creará en estado <strong>DRAFT</strong> para que puedas revisarla.
                        Después podrás activarla editándola y cambiando su estado.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="field">
                <label for="channels" class="font-semibold">
                  Canales de Distribución
                  <i class="pi pi-info-circle ml-2 text-500"
                     pTooltip="Medios por los que se enviará tu campaña. Por ahora solo Email está disponible"
                     tooltipPosition="right"></i>
                </label>
                <p-multiSelect
                  id="channels"
                  formControlName="channels"
                  [options]="channelOptions"
                  optionLabel="label"
                  optionValue="value"
                  optionDisabled="disabled"
                  placeholder="Selecciona canales"
                  class="w-full"
                ></p-multiSelect>
                <small class="text-500">
                  <strong>Email</strong> está activo. Próximamente: Facebook, Instagram, TikTok y X
                </small>
              </div>


              <div class="field">
                <label for="segmentation" class="font-semibold">
                  Segmentación de Audiencia
                  <i class="pi pi-info-circle ml-2 text-500"
                     pTooltip="Selecciona a qué grupo de clientes quieres llegar con esta campaña"
                     tooltipPosition="right"></i>
                </label>
                <p-multiSelect
                  id="segmentation"
                  formControlName="segmentation"
                  [options]="segmentationOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Selecciona segmentos"
                  class="w-full"
                  [pTooltip]="'Selecciona los segmentos de audiencia para tu campaña'"
                  tooltipPosition="top"
                ></p-multiSelect>
                <small class="text-500">
                  <strong>Ejemplos:</strong> Todos los clientes, Próximo cumpleaños (7 días), Activos últimos 30 días, VIP, etc.
                </small>
              </div>

              <!-- Activación Automática: campo removido del formulario. Default en backend = true -->
            </div>

            <!-- Botones de acción al final del formulario -->
            <p-divider></p-divider>
            <div class="flex justify-content-end gap-2 mt-4">
              <p-button
                label="Vista Previa"
                icon="pi pi-eye"
                [outlined]="true"
                (onClick)="openPreview()"
                ariaLabel="Vista previa ampliada"
              ></p-button>
              <p-button
                [label]="getActionButtonLabel()"
                [icon]="getActionButtonIcon()"
                [loading]="saving()"
                (onClick)="saveOrUpdate()"
                [ariaLabel]="getActionButtonLabel()"
              ></p-button>
            </div>
          </form>
        </p-card>
      </div>

      <!-- Right column: Live Preview (40%) -->
      <div class="col-12 lg:col-5 preview-column">
        <div class="preview-sticky">
          <p-card>
            <ng-template pTemplate="header">
              <div class="p-3">
                <h3 class="text-xl font-semibold m-0 flex align-items-center gap-2">
                  <i class="pi pi-eye"></i>
                  Vista Previa
                </h3>
              </div>
            </ng-template>

            <div class="campaign-preview">
              <!-- Preview Image -->
              <div class="preview-image-container" *ngIf="previewData().imageUrl">
                <img
                  [src]="previewData().imageUrl"
                  [alt]="previewData().title"
                  class="preview-main-image"
                />
              </div>

              <!-- Preview Content -->
              <div class="preview-content">
                <h2 class="preview-title">{{ previewData().title }}</h2>

                <p class="preview-subtitle" *ngIf="previewData().subtitle">
                  {{ previewData().subtitle }}
                </p>

                <p class="preview-description">
                  {{ previewData().description }}
                </p>

                <!-- Promo Badge -->
                <div class="preview-promo" *ngIf="previewData().promoType">
                  <p-chip
                    [label]="getPromoTypeLabel(previewData().promoType)"
                    styleClass="promo-chip"
                  ></p-chip>
                  <span class="promo-value" *ngIf="previewData().promoValue">
                    {{ previewData().promoValue }}
                  </span>
                </div>

                <!-- Dates -->
                <div class="preview-dates" *ngIf="previewData().startDate || previewData().endDate">
                  <div class="flex align-items-center gap-2 text-sm text-500">
                    <i class="pi pi-calendar"></i>
                    <span *ngIf="previewData().startDate">
                      Desde {{ formatDate(previewData().startDate) }}
                    </span>
                    <span *ngIf="previewData().endDate">
                      hasta {{ formatDate(previewData().endDate) }}
                    </span>
                  </div>
                </div>

                <!-- CTA Button - Always show -->
                <div class="preview-cta">
                  <p-button
                    [label]="previewData().buttonText"
                    icon="pi pi-arrow-right"
                    iconPos="right"
                    styleClass="w-full"
                  ></p-button>
                </div>
              </div>
            </div>
          </p-card>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Full Preview Dialog Component -->
<app-campaign-preview-dialog
  [(visible)]="previewDialogVisible"
  [previewData]="previewData()"
  [showButton]="true"
  [promoTypeOptions]="promoTypeOptions"
  [clientName]="clientName()"
  [clientLogo]="clientLogo()"
  [clientSlug]="clientSlug()"
  [rewardDescription]="currentReward()?.description"
></app-campaign-preview-dialog>

<p-toast></p-toast>
