<div class="reward-form-container">
  <form [formGroup]="rewardForm" (ngSubmit)="onSubmit()">
    <div class="form-section">
      <!-- Tipo de Reward -->
      <div class="field">
        <label for="rewardType" class="font-semibold">
          Tipo de beneficio <span class="text-red-500">*</span>
          <i class="pi pi-info-circle ml-2 text-500"
             pTooltip="Selecciona el tipo de beneficio que recibir√°n tus clientes. Cada tipo tiene configuraciones espec√≠ficas."
             tooltipPosition="right"></i>
        </label>
        <p-select #rewardTypeSelect
          id="rewardType"
          formControlName="rewardType"
          [options]="rewardTypes"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione el tipo de beneficio"
          class="w-full"
          [styleClass]="rewardForm.get('rewardType')?.invalid && rewardForm.get('rewardType')?.touched ? 'ng-invalid ng-dirty' : ''"
        ></p-select>

        <!-- Mensaje de error inline -->
        <p-message
          *ngIf="rewardForm.get('rewardType')?.invalid && rewardForm.get('rewardType')?.touched"
          severity="warn"
          text="Debes seleccionar un tipo de beneficio para continuar"
          styleClass="mt-2 w-full">
        </p-message>

        <!-- Mensaje de ayuda informativo -->
        <small class="text-500 block mt-2" *ngIf="!rewardForm.get('rewardType')?.value">
          üí° Elige c√≥mo quieres recompensar a tus clientes
        </small>
      </div>

      <!-- Valor Num√©rico (para PERCENT_DISCOUNT y FIXED_AMOUNT) -->
      <div class="field" *ngIf="showNumericValue">
        <label for="numericValue" class="font-semibold">
          {{ numericValueLabel }} <span class="text-red-500">*</span>
          <i class="pi pi-info-circle ml-2 text-500"
             [pTooltip]="selectedRewardType === 'PERCENT_DISCOUNT' ? 'Ingresa el porcentaje de descuento (1-100%)' : 'Ingresa el monto fijo en pesos que se descontar√°'"
             tooltipPosition="right"></i>
        </label>
        <p-inputnumber
          id="numericValue"
          formControlName="numericValue"
          class="w-full"
          [min]="0"
          [max]="selectedRewardType === 'PERCENT_DISCOUNT' ? 100 : 999999"
          [suffix]="selectedRewardType === 'PERCENT_DISCOUNT' ? '%' : ''"
          [prefix]="selectedRewardType === 'FIXED_AMOUNT' ? '$' : ''"
          [styleClass]="rewardForm.get('numericValue')?.invalid && rewardForm.get('numericValue')?.touched ? 'ng-invalid ng-dirty' : ''"
        ></p-inputnumber>
        <small class="p-error" *ngIf="rewardForm.get('numericValue')?.invalid && rewardForm.get('numericValue')?.touched">
          Este campo es requerido
        </small>
        <small class="text-500 block mt-1" *ngIf="!rewardForm.get('numericValue')?.invalid && selectedRewardType === 'PERCENT_DISCOUNT'">
          Ejemplo: 20 para un 20% de descuento
        </small>
        <small class="text-500 block mt-1" *ngIf="!rewardForm.get('numericValue')?.invalid && selectedRewardType === 'FIXED_AMOUNT'">
          Ejemplo: 50 para $50 de descuento
        </small>
      </div>

      <!-- ID de Producto (para FREE_PRODUCT) -->
      <div class="field" *ngIf="showProductId">
        <label for="productId" class="font-semibold">
          Producto a regalar <span class="text-red-500">*</span>
          <i class="pi pi-info-circle ml-2 text-500"
             pTooltip="Selecciona la categor√≠a y luego el producto que se regalar√°."
             tooltipPosition="right"></i>
        </label>
        <p-treeSelect
          [options]="productTree"
          selectionMode="single"
          placeholder="Selecciona categor√≠a ‚Üí producto"
          [ngModel]="selectedProductKey"
          [ngModelOptions]="{standalone: true}"
          (ngModelChange)="onProductTreeSelect($event)"
          [style]="{ width: '100%' }"
          [filter]="true"
        ></p-treeSelect>
        <small class="p-error" *ngIf="rewardForm.get('productId')?.invalid && rewardForm.get('productId')?.touched">
          Debes seleccionar un producto
        </small>
      </div>

      <!-- Cantidades para BUY_X_GET_Y -->
      <div class="field" *ngIf="showBuyGetQuantities">
        <label for="buyQuantity" class="font-semibold">
          Cantidad a comprar <span class="text-red-500">*</span>
          <i class="pi pi-info-circle ml-2 text-500"
             pTooltip="N√∫mero de productos que el cliente debe comprar para recibir el beneficio"
             tooltipPosition="right"></i>
        </label>
        <p-inputnumber
          id="buyQuantity"
          formControlName="buyQuantity"
          class="w-full"
          [min]="1"
          [useGrouping]="false"
          [styleClass]="rewardForm.get('buyQuantity')?.invalid && rewardForm.get('buyQuantity')?.touched ? 'ng-invalid ng-dirty' : ''"
        ></p-inputnumber>
        <small class="p-error" *ngIf="rewardForm.get('buyQuantity')?.invalid && rewardForm.get('buyQuantity')?.touched">
          Este campo es requerido
        </small>
        <small class="text-500 block mt-1" *ngIf="!rewardForm.get('buyQuantity')?.invalid">
          Ejemplo: 2 para "Compra 2"
        </small>
      </div>

      <div class="field" *ngIf="showBuyGetQuantities">
        <label for="freeQuantity" class="font-semibold">
          Cantidad gratis <span class="text-red-500">*</span>
          <i class="pi pi-info-circle ml-2 text-500"
             pTooltip="N√∫mero de productos que el cliente recibir√° gratis al completar la compra"
             tooltipPosition="right"></i>
        </label>
        <p-inputnumber
          id="freeQuantity"
          formControlName="freeQuantity"
          class="w-full"
          [min]="1"
          [useGrouping]="false"
          [styleClass]="rewardForm.get('freeQuantity')?.invalid && rewardForm.get('freeQuantity')?.touched ? 'ng-invalid ng-dirty' : ''"
        ></p-inputnumber>
        <small class="p-error" *ngIf="rewardForm.get('freeQuantity')?.invalid && rewardForm.get('freeQuantity')?.touched">
          Este campo es requerido
        </small>
        <small class="text-500 block mt-1" *ngIf="!rewardForm.get('freeQuantity')?.invalid">
          Ejemplo: 1 para "Lleva 1 gratis"
        </small>
      </div>

      <!-- Descripci√≥n (requerida solo si NO es NONE) -->
      <div class="field" *ngIf="selectedRewardType && selectedRewardType !== 'NONE'">
        <div class="flex justify-content-between align-items-center mb-2">
          <label for="description" class="font-semibold">
            Descripci√≥n <span class="text-red-500">*</span>
            <i class="pi pi-info-circle ml-2 text-500"
               pTooltip="Describe claramente el beneficio que recibir√°n los clientes. M√°ximo 500 caracteres." tooltipPosition="right"></i>
          </label>
          <small class="text-500">
            {{ (rewardForm.get('description')?.value || '').length }}/500
          </small>
        </div>
        <textarea
          pTextarea
          id="description"
          formControlName="description"
          rows="3"
          class="w-full"
          placeholder="Descripci√≥n del beneficio (m√°ximo 500 caracteres)"
          [class.ng-invalid]="rewardForm.get('description')?.invalid && rewardForm.get('description')?.touched"
          [class.ng-dirty]="rewardForm.get('description')?.invalid && rewardForm.get('description')?.touched"
          maxlength="500"
        ></textarea>
        <small class="p-error" *ngIf="rewardForm.get('description')?.hasError('required') && rewardForm.get('description')?.touched">
          Este campo es requerido
        </small>
        <small class="p-error" *ngIf="rewardForm.get('description')?.hasError('maxlength') && rewardForm.get('description')?.touched">
          La descripci√≥n no puede exceder 500 caracteres
        </small>
        <small class="text-500 block mt-1" *ngIf="!rewardForm.get('description')?.invalid">
          Explica claramente qu√© recibir√° el cliente
        </small>
      </div>

      <!-- Mensaje informativo cuando se selecciona NONE -->
      <div class="field" *ngIf="selectedRewardType === 'NONE'">
        <div class="p-3 border-round bg-blue-50 border-1 border-blue-200">
          <div class="flex align-items-start gap-2">
            <i class="pi pi-info-circle text-blue-600 mt-1"></i>
            <div>
              <p class="m-0 font-semibold text-blue-900">Campa√±a sin beneficio econ√≥mico</p>
              <p class="m-0 mt-1 text-sm text-blue-800">
                Esta campa√±a ser√° solo promocional (por ejemplo: lanzamiento de nuevo producto, anuncio de evento, etc.).
                No se asignar√° ning√∫n descuento o beneficio econ√≥mico a los clientes.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Campos opcionales (solo si NO es NONE) -->
      <div class="field" *ngIf="selectedRewardType && selectedRewardType !== 'NONE'">
        <label for="minPurchaseAmount" class="font-semibold">
          Monto m√≠nimo de compra (opcional)
          <i class="pi pi-info-circle ml-2 text-500"
             pTooltip="Define un monto m√≠nimo de compra para que el beneficio sea v√°lido"
             tooltipPosition="right"></i>
        </label>
        <p-inputnumber
          id="minPurchaseAmount"
          formControlName="minPurchaseAmount"
          class="w-full"
          [min]="0"
          prefix="$"
          placeholder="0.00"
        ></p-inputnumber>
        <small class="text-500 block mt-1">
          Ejemplo: $500 m√≠nimo de compra para usar el beneficio
        </small>
      </div>

      <div class="field" *ngIf="selectedRewardType && selectedRewardType !== 'NONE'">
        <label for="usageLimit" class="font-semibold">
          L√≠mite de uso (opcional)
          <i class="pi pi-info-circle ml-2 text-500"
             pTooltip="N√∫mero m√°ximo de veces que este beneficio puede ser usado en total"
             tooltipPosition="right"></i>
        </label>
        <p-inputnumber
          id="usageLimit"
          formControlName="usageLimit"
          class="w-full"
          [min]="1"
          [useGrouping]="false"
          placeholder="Sin l√≠mite"
        ></p-inputnumber>
        <small class="text-500 block mt-1">
          Ejemplo: 100 para limitar a 100 usos totales
        </small>
      </div>

      <!-- Botones de acci√≥n removidos - el guardado se maneja desde el bot√≥n principal de la campa√±a -->
    </div>
  </form>
</div>
