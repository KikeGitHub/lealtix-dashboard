<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="card">

  <div class="page-header">
    <div class="header-content">
      <i class="pi pi-ticket header-icon"></i>
      <div>
        <h1 class="page-title">Redenci贸n Manual de Cupones</h1>
        <p class="page-subtitle">Valida y redime cupones ingresando el c贸digo</p>
      </div>
    </div>
  </div>

    <!-- IDLE STATE - FORMULARIO DE ENTRADA -->
    <p-card *ngIf="pageState === 'idle'" styleClass="input-card">
      <ng-template pTemplate="header">
        <div class="card-header-simple">
          <i class="pi pi-search"></i>
          <h2>Buscar Cup贸n</h2>
        </div>
      </ng-template>

      <div class="input-section">
        <p-message
          severity="info"
          text="Ingrese el c贸digo del cup贸n que desea validar"
          styleClass="info-message">
        </p-message>

        <div class="input-group">
          <label for="couponCode" class="input-label">
            <i class="pi pi-ticket"></i>
            C贸digo del Cup贸n
          </label>
          <input
            pInputText
            id="couponCode"
            [(ngModel)]="couponCode"
            placeholder="Ej: ABC123XYZ"
            class="coupon-input"
            (keyup.enter)="onValidateCoupon()"
            [disabled]="pageState !== 'idle'"
            autocomplete="off" />
        </div>

        <p-button
          label="Validar Cup贸n"
          icon="pi pi-search"
          styleClass="validate-button"
          (onClick)="onValidateCoupon()"
          [disabled]="!couponCode || couponCode.trim() === ''">
        </p-button>
      </div>
    </p-card>

    <!-- VALIDATING STATE -->
    <p-card *ngIf="pageState === 'validating'" styleClass="loading-card">
      <div class="loading-content">
        <p-progressSpinner
          styleClass="spinner-custom"
          strokeWidth="4"
          fill="transparent"
          animationDuration="1s">
        </p-progressSpinner>
        <p class="loading-text">Validando cup贸n...</p>
        <p class="loading-subtext">Por favor espere</p>
      </div>
    </p-card>

    <!-- VALID STATE -->
    <p-card *ngIf="pageState === 'valid'" styleClass="coupon-card valid-card">
      <ng-template pTemplate="header">
        <div class="card-header-success">
          <i class="pi pi-check-circle success-icon"></i>
          <div>
            <h2>CUPN VLIDO</h2>
            <p class="header-subtitle">Listo para redimir</p>
          </div>
        </div>
      </ng-template>

      <div class="coupon-details">
        <!-- Status Badge -->
        <div class="status-section">
          <span class="status-label">Estado:</span>
          <p-tag
            [value]="getStatusText(validationData?.status)"
            [severity]="getStatusSeverity(validationData?.status)"
            styleClass="status-tag">
          </p-tag>
        </div>

        <p-divider></p-divider>

        <!-- Benefit Highlight -->
        <div class="benefit-highlight">
          <i class="pi pi-gift benefit-icon"></i>
          <div class="benefit-content">
            <span class="benefit-label">Beneficio</span>
            <h3 class="benefit-title">{{ validationData?.benefit }}</h3>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Customer & Campaign Info -->
        <div class="info-grid">
          <div class="info-item">
            <i class="pi pi-user"></i>
            <div class="info-details">
              <span class="info-label">Cliente</span>
              <span class="info-value">{{ validationData?.customerName }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-envelope"></i>
            <div class="info-details">
              <span class="info-label">Email</span>
              <span class="info-value">{{ validationData?.customerEmail }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-tag"></i>
            <div class="info-details">
              <span class="info-label">Campa帽a</span>
              <span class="info-value">{{ validationData?.campaignTitle }}</span>
            </div>
          </div>

          <div class="info-item" *ngIf="validationData?.campaignDescription">
            <i class="pi pi-info-circle"></i>
            <div class="info-details">
              <span class="info-label">Descripci贸n</span>
              <span class="info-value">{{ validationData?.campaignDescription }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-calendar"></i>
            <div class="info-details">
              <span class="info-label">V谩lido hasta</span>
              <span class="info-value">{{ formatDate(validationData?.expiresAt) }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-ticket"></i>
            <div class="info-details">
              <span class="info-label">C贸digo</span>
              <span class="info-value coupon-code">{{ validationData?.couponCode }}</span>
            </div>
          </div>
        </div>

        <!-- Warnings -->
        <div *ngIf="validationData?.alreadyRedeemed" class="warning-section">
          <p-message
            severity="warn"
            text="Este cup贸n ya fue redimido anteriormente"
            styleClass="warning-message">
          </p-message>
        </div>

        <div *ngIf="validationData?.isExpired" class="warning-section">
          <p-message
            severity="error"
            text="Este cup贸n ha expirado y no puede ser redimido"
            styleClass="error-message">
          </p-message>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <div class="button-group">
          <p-button
            label="Cancelar"
            icon="pi pi-times"
            styleClass="secondary-button"
            (onClick)="onValidateAnother()">
          </p-button>
          <p-button
            label=" Redimir Cup贸n"
            icon="pi pi-check"
            styleClass="redeem-button"
            (onClick)="onRedeemCoupon()"
            [disabled]="!canRedeem()">
          </p-button>
        </div>
      </ng-template>
    </p-card>

    <!-- REDEEMING STATE -->
    <p-card *ngIf="pageState === 'redeeming'" styleClass="loading-card">
      <div class="loading-content">
        <p-progressSpinner
          styleClass="spinner-custom"
          strokeWidth="4"
          fill="transparent"
          animationDuration="1s">
        </p-progressSpinner>
        <p class="loading-text">Redimiendo cup贸n...</p>
        <p class="loading-subtext">Procesando redenci贸n</p>
      </div>
    </p-card>

    <!-- SUCCESS STATE -->
    <p-card *ngIf="pageState === 'success'" styleClass="coupon-card success-card">
      <ng-template pTemplate="header">
        <div class="card-header-success">
          <i class="pi pi-check-circle success-icon large"></i>
          <div>
            <h2>隆CUPN REDIMIDO!</h2>
            <p class="header-subtitle">Redenci贸n completada exitosamente</p>
          </div>
        </div>
      </ng-template>

      <div class="coupon-details">
        <p-message
          severity="success"
          [text]="redemptionData?.message || 'El cup贸n ha sido redimido exitosamente'"
          styleClass="success-message">
        </p-message>

        <p-divider></p-divider>

        <!-- Benefit Applied -->
        <div class="benefit-highlight success">
          <i class="pi pi-check-circle benefit-icon"></i>
          <div class="benefit-content">
            <span class="benefit-label">Beneficio Aplicado</span>
            <h3 class="benefit-title">{{ redemptionData?.benefit }}</h3>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Redemption Details -->
        <div class="info-grid">
          <div class="info-item">
            <i class="pi pi-user"></i>
            <div class="info-details">
              <span class="info-label">Cliente</span>
              <span class="info-value">{{ redemptionData?.customerName }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-envelope"></i>
            <div class="info-details">
              <span class="info-label">Email</span>
              <span class="info-value">{{ redemptionData?.customerEmail }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-calendar"></i>
            <div class="info-details">
              <span class="info-label">Fecha de redenci贸n</span>
              <span class="info-value">{{ formatDate(redemptionData?.redeemedAt) }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-user-edit"></i>
            <div class="info-details">
              <span class="info-label">Redimido por</span>
              <span class="info-value">{{ redemptionData?.redeemedBy }}</span>
            </div>
          </div>

          <div class="info-item" *ngIf="redemptionData?.redemptionId">
            <i class="pi pi-hashtag"></i>
            <div class="info-details">
              <span class="info-label">ID de Redenci贸n</span>
              <span class="info-value coupon-code">{{ redemptionData?.redemptionId }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-ticket"></i>
            <div class="info-details">
              <span class="info-label">C贸digo del cup贸n</span>
              <span class="info-value coupon-code">{{ redemptionData?.couponCode }}</span>
            </div>
          </div>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-button
          label="Redimir otro cup贸n"
          icon="pi pi-refresh"
          styleClass="primary-button"
          (onClick)="onValidateAnother()">
        </p-button>
      </ng-template>
    </p-card>

    <!-- ALREADY REDEEMED STATE -->
    <p-card *ngIf="pageState === 'already-redeemed'" styleClass="coupon-card error-card">
      <ng-template pTemplate="header">
        <div class="card-header-error">
          <i class="pi pi-check-circle error-icon"></i>
          <div>
            <h2>Cup贸n Ya Redimido</h2>
            <p class="header-subtitle">Este cup贸n fue utilizado anteriormente</p>
          </div>
        </div>
      </ng-template>

      <div class="coupon-details">
        <p-message
          severity="warn"
          text="Este cup贸n ya fue redimido y no puede volver a utilizarse"
          styleClass="warning-message">
        </p-message>

        <p-divider></p-divider>

        <!-- Informaci贸n del Cup贸n -->
        <div class="benefit-highlight">
          <i class="pi pi-gift benefit-icon"></i>
          <div class="benefit-content">
            <span class="benefit-label">Beneficio Aplicado</span>
            <h3 class="benefit-title">{{ validationData?.benefit }}</h3>
          </div>
        </div>

        <p-divider></p-divider>

        <h3 class="section-title">Informaci贸n de la Redenci贸n</h3>

        <!-- Detalles de la Redenci贸n -->
        <div class="info-grid">
          <div class="info-item">
            <i class="pi pi-calendar"></i>
            <div class="info-details">
              <span class="info-label">Redimido el</span>
              <span class="info-value">{{ formatDate(validationData?.redeemedAt) }}</span>
            </div>
          </div>

          <div class="info-item" *ngIf="validationData?.redeemedBy">
            <i class="pi pi-user-edit"></i>
            <div class="info-details">
              <span class="info-label">Redimido por</span>
              <span class="info-value">{{ validationData?.redeemedBy }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-ticket"></i>
            <div class="info-details">
              <span class="info-label">C贸digo del cup贸n</span>
              <span class="info-value coupon-code">{{ validationData?.couponCode }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-info-circle"></i>
            <div class="info-details">
              <span class="info-label">Estado</span>
              <p-tag
                value="Redimido"
                severity="secondary"
                styleClass="status-tag">
              </p-tag>
            </div>
          </div>
        </div>

        <p-divider></p-divider>

        <h3 class="section-title">Informaci贸n del Cliente</h3>

        <div class="info-grid">
          <div class="info-item">
            <i class="pi pi-user"></i>
            <div class="info-details">
              <span class="info-label">Cliente</span>
              <span class="info-value">{{ validationData?.customerName }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-envelope"></i>
            <div class="info-details">
              <span class="info-label">Email</span>
              <span class="info-value">{{ validationData?.customerEmail }}</span>
            </div>
          </div>

          <div class="info-item">
            <i class="pi pi-tag"></i>
            <div class="info-details">
              <span class="info-label">Campa帽a</span>
              <span class="info-value">{{ validationData?.campaignTitle }}</span>
            </div>
          </div>

          <div class="info-item" *ngIf="validationData?.campaignDescription">
            <i class="pi pi-align-left"></i>
            <div class="info-details">
              <span class="info-label">Descripci贸n</span>
              <span class="info-value">{{ validationData?.campaignDescription }}</span>
            </div>
          </div>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-button
          label="Validar otro cup贸n"
          icon="pi pi-refresh"
          styleClass="secondary-button"
          (onClick)="onValidateAnother()">
        </p-button>
      </ng-template>
    </p-card>

    <!-- ERROR STATE -->
    <p-card *ngIf="pageState === 'error'" styleClass="coupon-card error-card">
      <ng-template pTemplate="header">
        <div class="card-header-error">
          <i class="pi pi-times-circle error-icon"></i>
          <div>
            <h2>Error</h2>
            <p class="header-subtitle">No se pudo procesar la solicitud</p>
          </div>
        </div>
      </ng-template>

      <div class="coupon-details">
        <p-message
          severity="error"
          [text]="errorMessage"
          styleClass="error-message">
        </p-message>

        <div *ngIf="validationData && !validationData.valid" class="error-details">
          <p-divider></p-divider>

          <div class="info-grid">
            <div class="info-item" *ngIf="validationData.couponCode">
              <i class="pi pi-ticket"></i>
              <div class="info-details">
                <span class="info-label">C贸digo buscado</span>
                <span class="info-value">{{ validationData.couponCode }}</span>
              </div>
            </div>

            <div class="info-item" *ngIf="validationData.alreadyRedeemed">
              <i class="pi pi-exclamation-triangle"></i>
              <div class="info-details">
                <span class="info-label">Estado</span>
                <span class="info-value">Ya redimido</span>
              </div>
            </div>

            <div class="info-item" *ngIf="validationData.isExpired">
              <i class="pi pi-clock"></i>
              <div class="info-details">
                <span class="info-label">Estado</span>
                <span class="info-value">Expirado</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-button
          label="Intentar nuevamente"
          icon="pi pi-refresh"
          styleClass="secondary-button"
          (onClick)="onValidateAnother()">
        </p-button>
      </ng-template>
    </p-card>

</div>
