<div class="manual-input-container">
  <p-toast></p-toast>

  <p-card styleClass="input-card">
    <ng-template pTemplate="header">
      <div class="card-header">
        <i class="pi pi-qrcode"></i>
        <h2>Redención Manual de Cupón</h2>
      </div>
    </ng-template>

    <div class="input-content">
      <p class="description">
        Ingresa el código del cupón y el monto de compra para validar el descuento:
      </p>

      <div class="form-group">
        <label for="couponCode" class="form-label">Código del Cupón</label>
        <input
          type="text"
          pInputText
          id="couponCode"
          [(ngModel)]="couponCode"
          placeholder="Ej: CAMP21-ABC123"
          (keyup.enter)="validateCode()"
          class="code-input"
          [disabled]="loading"
          autofocus
        />
      </div>

      <div class="form-group">
        <label for="purchaseAmount" class="form-label">Monto de Compra</label>
        <p-inputNumber
          id="purchaseAmount"
          [(ngModel)]="purchaseAmount"
          mode="decimal"
          prefix="$"
          locale="en-US"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          [min]="0"
          placeholder="0.00"
          styleClass="w-full"
          inputStyleClass="w-full"
          [disabled]="loading"
        ></p-inputNumber>
        <small class="text-red-600 mt-1 block font-semibold" *ngIf="purchaseAmount !== undefined && purchaseAmount !== null && purchaseAmount > 0 && rewardData && purchaseAmount < rewardData.minPurchaseAmount">
          <i class="pi pi-exclamation-triangle"></i>
          Este cupón requiere una compra mínima de ${{ rewardData.minPurchaseAmount.toFixed(2) }}
        </small>
      </div>

      <div class="button-group">
        <p-button
          label="Validar Cupón"
          icon="pi pi-check"
          (onClick)="validateCode()"
          [disabled]="!couponCode || couponCode.length < 3 || loading"
          [loading]="loading"
          styleClass="validate-button w-full">
        </p-button>
      </div>

      <p-message
        *ngIf="errorMessage"
        severity="error"
        [text]="errorMessage"
        styleClass="error-message">
      </p-message>

      <!-- Resultado del descuento -->
      <div *ngIf="showResult && rewardData" class="result-section">
        <p-divider></p-divider>

        <h3 class="result-title">
          <i class="pi pi-check-circle"></i>
          Cupón Validado
        </h3>

        <div class="reward-info">
          <p class="reward-description">{{ rewardData.description }}</p>
          <div class="info-requirements">
            <div class="requirement-item" *ngIf="rewardData.minPurchaseAmount > 0">
              <i class="pi pi-shopping-cart"></i>
              <div class="requirement-content">
                <span class="requirement-label">Compra mínima:</span>
                <span class="requirement-value">${{ rewardData.minPurchaseAmount.toFixed(2) }}</span>
              </div>
            </div>
            <div class="requirement-item" *ngIf="rewardData.usageLimit > 0">
              <i class="pi pi-replay"></i>
              <div class="requirement-content">
                <span class="requirement-label">Límite de uso:</span>
                <span class="requirement-value">{{ rewardData.usageCount }} / {{ rewardData.usageLimit }}</span>
              </div>
            </div>
          </div>

          <p-divider *ngIf="rewardData.minPurchaseAmount > 0 || rewardData.usageLimit > 0"></p-divider>
          <div class="calculation-details">
            <div class="detail-row">
              <span class="detail-label">Monto original:</span>
              <span class="detail-value">${{ (purchaseAmount ?? 0).toFixed(2) }}</span>
            </div>

            <div class="detail-row discount-row">
              <span class="detail-label">
                Descuento
                <span *ngIf="rewardData.rewardType === 'PERCENT_DISCOUNT'">
                  ({{ rewardData.numericValue }}%)
                </span>
                <span *ngIf="rewardData.rewardType === 'FIXED_AMOUNT'">
                  (${{ rewardData.numericValue }})
                </span>:
              </span>
              <span class="detail-value discount-value">-${{ discountAmount.toFixed(2) }}</span>
            </div>

            <p-divider></p-divider>

            <div class="detail-row total-row">
              <span class="detail-label"><strong>Total a pagar:</strong></span>
              <span class="detail-value total-value"><strong>${{ finalAmount.toFixed(2) }}</strong></span>
            </div>
          </div>

          <div class="usage-info">
            <small>
              <i class="pi pi-info-circle"></i>
              Uso {{ rewardData.usageCount + 1 }} de {{ rewardData.usageLimit }}
            </small>
          </div>
        </div>

        <div class="action-buttons">
          <p-button
            label="Aplicar Descuento"
            icon="pi pi-check"
            severity="success"
            styleClass="w-full mb-2">
          </p-button>
          <p-button
            label="Cancelar"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            (onClick)="resetForm()"
            styleClass="w-full">
          </p-button>
        </div>
      </div>
    </div>
  </p-card>
</div>
