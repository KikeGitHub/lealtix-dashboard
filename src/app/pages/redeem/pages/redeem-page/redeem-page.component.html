<div class="redeem-container">
  <div class="redeem-wrapper">

    <!-- HEADER -->
    <div class="redeem-header">
      <h1>
        <a href="http://lealtix.com.mx" target="_blank" rel="noopener noreferrer" class="lealtix-link">
          üéüÔ∏è LEALTIX
        </a>
      </h1>
      <p class="subtitle">Redenci√≥n de Cupones</p>
    </div>

    <!-- LOADING STATE -->
    <div *ngIf="pageState === 'loading'" class="loading-container">
      <p-progressSpinner
        styleClass="spinner-custom"
        strokeWidth="4"
        fill="transparent"
        animationDuration="1s">
      </p-progressSpinner>
      <p class="loading-text">Validando cup√≥n...</p>
    </div>

    <!-- VALID COUPON STATE -->
    <p-card *ngIf="pageState === 'valid'" styleClass="coupon-card valid-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-check-circle success-icon"></i>
          <h2>CUP√ìN V√ÅLIDO</h2>
          <p class="view-mode-text" *ngIf="!isStaffView">Vista de Cliente</p>
        </div>
      </ng-template>

      <div class="coupon-content">
        <div class="status-row">
          <span class="label">Estado:</span>
          <p-tag
            [value]="getStatusText(validationData?.status)"
            [severity]="getStatusSeverity(validationData?.status)"
            styleClass="status-tag">
          </p-tag>
        </div>

        <p-divider></p-divider>

        <div class="info-section">
          <!-- Cliente: solo visible para staff -->
          <div class="info-row" *ngIf="isStaffView">
            <i class="pi pi-user icon"></i>
            <div class="info-content">
              <span class="info-label">Cliente</span>
              <span class="info-value">{{ validationData?.customerName }}</span>
            </div>
          </div>

          <div class="benefit-box">
            <i class="pi pi-gift"></i>
            <div class="benefit-content">
              <span class="benefit-label">Beneficio</span>
              <h3 class="benefit-text">{{ validationData?.benefit || validationData?.rewardDescription }}</h3>
            </div>
          </div>

          <div class="info-row">
            <i class="pi pi-tag icon"></i>
            <div class="info-content">
              <span class="info-label">Campa√±a</span>
              <span class="info-value">{{ validationData?.campaignTitle }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="validationData?.campaignDescription">
            <i class="pi pi-info-circle icon"></i>
            <div class="info-content">
              <span class="info-label">Descripci√≥n</span>
              <span class="info-value">{{ validationData?.campaignDescription }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="validationData?.couponType && validationData?.couponValue">
            <i class="pi pi-percentage icon"></i>
            <div class="info-content">
              <span class="info-label">Tipo de Descuento</span>
              <span class="info-value">
                <span *ngIf="validationData?.couponType === 'PERCENT_DISCOUNT' || validationData?.rewardType === 'PERCENT_DISCOUNT'">
                  {{ validationData?.couponValue || validationData?.numericValue }}% de descuento
                </span>
                <span *ngIf="validationData?.couponType === 'FIXED_AMOUNT' || validationData?.rewardType === 'FIXED_AMOUNT'">
                  ${{ validationData?.couponValue || validationData?.numericValue }} de descuento
                </span>
                <span *ngIf="validationData?.couponType === 'FREE_ITEM' || validationData?.rewardType === 'FREE_ITEM'">
                  Art√≠culo gratis
                </span>
              </span>
            </div>
          </div>

          <div class="info-row" *ngIf="rewardData?.minPurchaseAmount || validationData?.minRedemptionAmount || validationData?.minPurchaseAmount">
            <i class="pi pi-shopping-cart icon"></i>
            <div class="info-content">
              <span class="info-label">Compra M√≠nima</span>
              <span class="info-value">
                ${{ (rewardData?.minPurchaseAmount || validationData?.minPurchaseAmount || validationData?.minRedemptionAmount || 0).toFixed(2) }}
              </span>
            </div>
          </div>

          <div class="info-row" *ngIf="rewardData?.usageLimit || validationData?.usageLimit">
            <i class="pi pi-replay icon"></i>
            <div class="info-content">
              <span class="info-label">L√≠mite de Uso</span>
              <span class="info-value">{{ rewardData?.usageCount || validationData?.usageCount || 0 }} / {{ rewardData?.usageLimit || validationData?.usageLimit }}</span>
            </div>
          </div>

          <div class="info-row">
            <i class="pi pi-calendar icon"></i>
            <div class="info-content">
              <span class="info-label">V√°lido hasta</span>
              <span class="info-value">{{ formatDate(validationData?.expiresAt) }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="validationData?.couponCode">
            <i class="pi pi-ticket icon"></i>
            <div class="info-content">
              <span class="info-label">C√≥digo</span>
              <span class="info-value code">{{ validationData?.couponCode }}</span>
            </div>
          </div>
        </div>

        <!-- Mensaje para clientes -->
        <div *ngIf="!isStaffView" class="client-message">
          <p-message
            severity="info"
            text="Muestra este cup√≥n al personal del negocio para redimirlo."
            styleClass="info-message">
          </p-message>
        </div>
      </div>

      <!-- Footer: bot√≥n solo visible para staff -->
      <ng-template pTemplate="footer" *ngIf="isStaffView">
        <p-button
          label="üéÅ REDIMIR CUP√ìN"
          styleClass="redeem-button"
          (onClick)="onRedeemCoupon()"
          [disabled]="isRedeeming">
        </p-button>
      </ng-template>
    </p-card>

    <!-- REDEEMING STATE -->
    <p-card *ngIf="pageState === 'redeeming'" styleClass="coupon-card redeeming-card">
      <div class="loading-container">
        <p-progressSpinner
          styleClass="spinner-custom"
          strokeWidth="4"
          fill="transparent"
          animationDuration="1s">
        </p-progressSpinner>
        <p class="loading-text">Redimiendo cup√≥n...</p>
        <p class="loading-subtext">Por favor espere</p>
      </div>
    </p-card>

    <!-- SUCCESS STATE -->
    <p-card *ngIf="pageState === 'success'" styleClass="coupon-card success-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-check-circle success-icon large"></i>
          <h2>¬°CUP√ìN REDIMIDO!</h2>
        </div>
      </ng-template>

      <div class="coupon-content">
        <p-message
          severity="success"
          [text]="redemptionData?.message || 'El cup√≥n se ha redimido exitosamente'"
          styleClass="success-message">
        </p-message>

        <p-divider></p-divider>

        <div class="info-section">
          <div class="info-row">
            <i class="pi pi-user icon"></i>
            <div class="info-content">
              <span class="info-label">Cliente</span>
              <span class="info-value">{{ redemptionData?.customerName }}</span>
            </div>
          </div>

          <div class="benefit-box success">
            <i class="pi pi-gift"></i>
            <div class="benefit-content">
              <span class="benefit-label">Beneficio aplicado</span>
              <h3 class="benefit-text">{{ redemptionData?.benefit }}</h3>
            </div>
          </div>

          <div class="info-row" *ngIf="redemptionData?.originalAmount">
            <i class="pi pi-shopping-cart icon"></i>
            <div class="info-content">
              <span class="info-label">Monto Original</span>
              <span class="info-value">${{ redemptionData?.originalAmount?.toFixed(2) }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="redemptionData?.discountAmount">
            <i class="pi pi-tag icon"></i>
            <div class="info-content">
              <span class="info-label">Descuento Aplicado</span>
              <span class="info-value discount-value">-${{ redemptionData?.discountAmount?.toFixed(2) }}</span>
            </div>
          </div>

          <div class="info-row final-amount" *ngIf="redemptionData?.finalAmount">
            <i class="pi pi-money-bill icon"></i>
            <div class="info-content">
              <span class="info-label">Total a Pagar</span>
              <span class="info-value final-value">${{ redemptionData?.finalAmount?.toFixed(2) }}</span>
            </div>
          </div>

          <div class="info-row">
            <i class="pi pi-calendar icon"></i>
            <div class="info-content">
              <span class="info-label">Redimido el</span>
              <span class="info-value">{{ formatDate(redemptionData?.redeemedAt) }}</span>
            </div>
          </div>

          <div class="info-row">
            <i class="pi pi-user-edit icon"></i>
            <div class="info-content">
              <span class="info-label">Redimido por</span>
              <span class="info-value">{{ redemptionData?.redeemedBy }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="redemptionData?.redemptionId">
            <i class="pi pi-hashtag icon"></i>
            <div class="info-content">
              <span class="info-label">ID de Redenci√≥n</span>
              <span class="info-value code">{{ redemptionData?.redemptionId }}</span>
            </div>
          </div>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-button
          label="Validar otro cup√≥n"
          styleClass="secondary-button"
          icon="pi pi-refresh"
          (onClick)="onValidateAnother()">
        </p-button>
      </ng-template>
    </p-card>

    <!-- ALREADY REDEEMED STATE -->
    <p-card *ngIf="pageState === 'redeemed'" styleClass="coupon-card error-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-times-circle error-icon"></i>
          <h2>CUP√ìN YA REDIMIDO</h2>
        </div>
      </ng-template>

      <div class="coupon-content">
        <p-message
          severity="error"
          text="Este cup√≥n ya fue utilizado anteriormente"
          styleClass="error-message">
        </p-message>

        <p-divider></p-divider>

        <div class="info-section">
          <div class="status-row">
            <span class="label">Estado:</span>
            <p-tag
              [value]="getStatusText(validationData?.status)"
              severity="danger"
              styleClass="status-tag">
            </p-tag>
          </div>

          <div class="info-row" *ngIf="validationData?.redeemedAt">
            <i class="pi pi-calendar icon"></i>
            <div class="info-content">
              <span class="info-label">Fecha de redenci√≥n</span>
              <span class="info-value">{{ formatDate(validationData?.redeemedAt) }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="validationData?.campaignTitle">
            <i class="pi pi-tag icon"></i>
            <div class="info-content">
              <span class="info-label">Campa√±a</span>
              <span class="info-value">{{ validationData?.campaignTitle }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="validationData?.couponCode">
            <i class="pi pi-ticket icon"></i>
            <div class="info-content">
              <span class="info-label">C√≥digo</span>
              <span class="info-value code">{{ validationData?.couponCode }}</span>
            </div>
          </div>
        </div>
      </div>
    </p-card>

    <!-- EXPIRED STATE -->
    <p-card *ngIf="pageState === 'expired'" styleClass="coupon-card warning-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-clock error-icon"></i>
          <h2>CUP√ìN EXPIRADO</h2>
        </div>
      </ng-template>

      <div class="coupon-content">
        <p-message
          severity="warn"
          text="Este cup√≥n ya no es v√°lido"
          styleClass="warning-message">
        </p-message>

        <p-divider></p-divider>

        <div class="info-section">
          <div class="status-row">
            <span class="label">Estado:</span>
            <p-tag
              [value]="getStatusText(validationData?.status)"
              severity="warn"
              styleClass="status-tag">
            </p-tag>
          </div>

          <div class="info-row" *ngIf="validationData?.expiresAt">
            <i class="pi pi-calendar icon"></i>
            <div class="info-content">
              <span class="info-label">Fecha de expiraci√≥n</span>
              <span class="info-value">{{ formatDate(validationData?.expiresAt) }}</span>
            </div>
          </div>

          <div class="info-row" *ngIf="validationData?.campaignTitle">
            <i class="pi pi-tag icon"></i>
            <div class="info-content">
              <span class="info-label">Campa√±a</span>
              <span class="info-value">{{ validationData?.campaignTitle }}</span>
            </div>
          </div>
        </div>
      </div>
    </p-card>

    <!-- NOT FOUND STATE -->
    <p-card *ngIf="pageState === 'not-found'" styleClass="coupon-card error-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-exclamation-triangle error-icon"></i>
          <h2>CUP√ìN NO ENCONTRADO</h2>
        </div>
      </ng-template>

      <div class="coupon-content">
        <p-message
          severity="error"
          text="El cup√≥n no existe o no es v√°lido para este negocio"
          styleClass="error-message">
        </p-message>

        <p-divider></p-divider>

        <div class="help-text">
          <p><i class="pi pi-info-circle"></i> Por favor, verifica:</p>
          <ul>
            <li>El c√≥digo QR est√° completo y es legible</li>
            <li>El cup√≥n pertenece a este negocio</li>
            <li>El enlace no est√° corrupto</li>
          </ul>
        </div>
      </div>
    </p-card>

    <!-- ERROR STATE -->
    <p-card *ngIf="pageState === 'error'" styleClass="coupon-card error-card">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-times-circle error-icon"></i>
          <h2>ERROR</h2>
        </div>
      </ng-template>

      <div class="coupon-content">
        <p-message
          severity="error"
          [text]="errorMessage || 'Ocurri√≥ un error inesperado'"
          styleClass="error-message">
        </p-message>

        <p-divider></p-divider>

        <div class="help-text">
          <p>Por favor, intenta nuevamente o contacta al administrador.</p>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-button
          label="Intentar nuevamente"
          styleClass="secondary-button"
          icon="pi pi-refresh"
          (onClick)="onValidateAnother()">
        </p-button>
      </ng-template>
    </p-card>

  </div>
</div>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>

<!-- Amount Input Dialog -->
<p-dialog
  header="Ingrese el Monto de la Compra"
  [(visible)]="showAmountDialog"
  [modal]="true"
  [closable]="true"
  [style]="{width: '90vw', maxWidth: '450px'}"
  (onHide)="cancelAmountDialog()">

  <div class="amount-dialog-content">
    <p class="dialog-description">
      <i class="pi pi-info-circle"></i>
      Para redimir este cup√≥n, ingrese el monto total de la compra.
    </p>

    <div class="amount-info" *ngIf="minRedemptionAmount > 0">
      <p-message
        severity="info"
        [text]="'Compra m√≠nima requerida: $' + minRedemptionAmount.toFixed(2)"
        styleClass="w-full">
      </p-message>
    </div>

    <div class="field">
      <label for="originalAmount" class="amount-label">
        <i class="pi pi-money-bill"></i> Monto de la Compra
      </label>
      <p-inputNumber
        id="originalAmount"
        [(ngModel)]="originalAmount"
        mode="currency"
        currency="MXN"
        locale="es-MX"
        [minFractionDigits]="2"
        [maxFractionDigits]="2"
        placeholder="0.00"
        styleClass="w-full"
        inputStyleClass="w-full">
      </p-inputNumber>
      <small class="text-red-600 mt-2 block" *ngIf="originalAmount > 0 && originalAmount < minRedemptionAmount">
        <i class="pi pi-exclamation-triangle"></i>
        El monto debe ser al menos ${{ minRedemptionAmount.toFixed(2) }} para usar este cup√≥n
      </small>
    </div>

    <div class="preview-info" *ngIf="originalAmount >= minRedemptionAmount && rewardData">
      <p-divider></p-divider>
      <div class="preview-row">
        <span class="preview-label">Tipo de descuento:</span>
        <span class="preview-value">
          <span *ngIf="rewardData.rewardType === 'PERCENT_DISCOUNT'">
            {{ rewardData.numericValue }}% de descuento
          </span>
          <span *ngIf="rewardData.rewardType === 'FIXED_AMOUNT'">
            ${{ rewardData.numericValue.toFixed(2) }} de descuento fijo
          </span>
        </span>
      </div>
      <div class="preview-row">
        <span class="preview-label">Descuento aplicado:</span>
        <span class="preview-value discount-preview">
          <span *ngIf="rewardData.rewardType === 'PERCENT_DISCOUNT'">
            -${{ (originalAmount * rewardData.numericValue / 100).toFixed(2) }}
          </span>
          <span *ngIf="rewardData.rewardType === 'FIXED_AMOUNT'">
            -${{ Math.min(rewardData.numericValue, originalAmount).toFixed(2) }}
          </span>
        </span>
      </div>
      <div class="preview-row final">
        <span class="preview-label"><strong>Total a pagar:</strong></span>
        <span class="preview-value final-preview">
          <span *ngIf="rewardData.rewardType === 'PERCENT_DISCOUNT'">
            <strong>${{ (originalAmount - (originalAmount * rewardData.numericValue / 100)).toFixed(2) }}</strong>
          </span>
          <span *ngIf="rewardData.rewardType === 'FIXED_AMOUNT'">
            <strong>${{ (originalAmount - Math.min(rewardData.numericValue, originalAmount)).toFixed(2) }}</strong>
          </span>
        </span>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      styleClass="p-button-text"
      (onClick)="cancelAmountDialog()">
    </p-button>
    <p-button
      label="Continuar"
      icon="pi pi-check"
      (onClick)="confirmRedemption()"
      [disabled]="originalAmount < minRedemptionAmount">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Toast Messages -->
<p-toast position="top-center"></p-toast>
